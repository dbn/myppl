define(["jquery","underscore","backbone","model/cities","view/home/homecityview","view/home/homecitydetailedview","view/home/homeartistdetailedview","text!templates/home/hometmpl.html"],function(a,b,c,d,e,f,g,h){var i=c.View.extend({tagName:"div",cityViews:[],hiddenCityViews:[],artistDetailedView:(new g).render(),cityDetailedView:(new f).render(),isTemplateAppended:!1,activeCityView:null,isLoading:!0,initialize:function(){this.collection=d,this.collection.bind("reset",this.collectionChangeHandler,this),this.collection.fetch(),this.isLoading=!0,b.bindAll(this)},collectionChangeHandler:function(){var a=this.collection.models;for(var d=0;d<a.length;d++){var f=new e({model:a[d]});b.extend(f,c.Events),f.bind("citySelected",this.citySelected,this),f.bind("artistSelected",this.artistSelected,this),f.bind("backBtnMouseDown",this.cityBackBtnMouseDown,this),this.cityViews.push(f)}this.render()},loadAndRender:function(){var b=a.Deferred();return this.isLoadedAndRendered?(b.resolve(),b):(this.loadAndRenderDfrd=b,b)},resolveLoadedAndRendered:function(){this.isLoadedAndRendered=!0,this.loadAndRenderDfrd&&this.loadAndRenderDfrd.resolve()},render:function(){this.isTemplateAppended||(a(this.el).empty(),a(this.el).append(b.template(h)),this.isTemplateAppended=!0),a(this.el).find("#homeLoadingLbl").css("display","none");var c=this.collection.models;for(var d=0;d<this.cityViews.length;d++){this.cityViews[d].parentView=this,this.cityViews[d].render(),a(this.el).append(this.cityViews[d].el);var e=a(this.cityViews[d].el);e.css("position","absolute"),e.css("top",200*d)}return this.resolveLoadedAndRendered(),this},citySelected:function(a){var b=a.target.model.get("name");c.history.navigate("/city/"+b.toLowerCase(),{trigger:!0})},showCity:function(b){var c=this.activeCityView?this.activeCityView.model:null,d=this.getCityViewByName(b);if(!d)return;var e=this,f=c&&c.get("name").toLowerCase()==b.toLowerCase();this.currentView=="city"||this.currentView=="artist"?f?a.when(this.hidePrevDetailedView()).done(function(){e.showCityDetails(d)}):a.when(this.showHome()).done(function(){e.showCity(b)}):(this.currentView="city",this.elevateCityView(d).then(this.showCityDetails))},artistSelected:function(a){var b=a.relatedObject.model.get("name");c.history.navigate("/artist/"+b.toLowerCase(),{trigger:!0})},showArtist:function(b){var c=d.findArtist(b);if(!c)return;var e=this.getCityViewByName(c.get("city"));if(!e)return;e.model.set({selectedArtist:c}),c.set({selected:!0});var f=this,g=this.activeCityView?this.activeCityView.model:null;this.currentView=="artist"?g&&g.get("name").toLowerCase()!=c.get("city").toLowerCase()?a.when(this.showHome()).done(function(){f.showArtist(b)}):a.when(this.hidePrevDetailedView()).done(function(){f.showArtistDetails(e)}):this.currentView=="city"?a.when(this.hidePrevDetailedView()).done(function(){f.showArtistDetails(e)}):(this.currentView="artist",this.elevateCityView(e).then(this.showArtistDetails))},getCityViewByName:function(a){for(var b=0;b<this.cityViews.length;b++)if(this.cityViews[b].model.get("name").toLowerCase()==a.toLowerCase())return this.cityViews[b];return null},elevateCityView:function(c){var d=b.indexOf(this.cityViews,c);this.hiddenCityViews=b.without(this.cityViews,c);var e=b.map(this.hiddenCityViews,function(a){return a.el}),f=a.Deferred(),g=function(){return a(e).fadeOut(200)};return a.when(g()).done(function(){a(e).detach(),d!=0?a(c.el).animate({top:0},500,function(){f.resolve(c)}):f.resolve(c)}),f.promise()},showArtistDetails:function(b){this.activeCityView=b;var c=b.model.get("selectedArtist");this.artistDetailedView.setModel(c),c.set({selected:!0}),c.loadExcerpt();var d=a(this.artistDetailedView.render().el),e=b.model.get("artists").indexOf(c);if(e==-1)return;var f=130+(e<2?e:1)*180;d.css("left",f),d.css("top",a(b.el).height()),a(this.el).append(d),a.when(d.fadeIn(200)).done(function(){b.showBackButton()}),this.currentView="artist"},showCityDetails:function(b){this.activeCityView=b,this.cityDetailedView.setModel(b.model),b.model.loadExcerpt();var c=a(this.cityDetailedView.render().el);a(this.el).append(c),a.when(c.fadeIn(200)).done(function(){b.showBackButton()}),this.currentView="city"},getCurrentDetailedView:function(){return this.currentView=="artist"?this.artistDetailedView:this.currentView=="city"?this.cityDetailedView:null},hidePrevDetailedView:function(){var b=a.Deferred();this.activeCityView.unselect();var c=this.getCurrentDetailedView();return a.when(a(c.el).fadeOut(500)).done(function(){a(c.el).detach(),b.resolve()}),b.promise()},cityBackBtnMouseDown:function(a){c.history.navigate("/",{trigger:!0})},showHome:function(){var c=a.Deferred();if(this.currentView!="artist"&&this.currentView!="city")return c.resolve(),c;var d=b.map(this.hiddenCityViews,function(a){return a.el});this.cityViews=[this.activeCityView].concat(this.hiddenCityViews),this.activeCityView.hideBackButton();var e=this.activeCityView.model.get("selectedArtist"),f=this;return a.when(this.hidePrevDetailedView()).done(function(){for(var b=0;b<f.cityViews.length;b++){var e=a(f.cityViews[b].el);e.css("position","absolute"),e.css("top",200*b)}a(d).appendTo(a(f.el)),f.activeCityView=null,f.hiddenCityViews.length=0,f.currentView="home",a.when(a(d).fadeIn(200)).done(c.resolve())}),c}});return i})